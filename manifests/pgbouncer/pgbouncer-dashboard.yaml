# Grafana dashboard for PgBouncer pool metrics.
# Discovered automatically by the Grafana sidecar (label: grafana_dashboard=1).
# Folder: Infrastructure
#
# Metrics exposed by prometheuscommunity/pgbouncer-exporter:
#   pgbouncer_pools_client_active   — clients currently in a server session
#   pgbouncer_pools_client_waiting  — clients waiting for a free server connection (queue depth)
#   pgbouncer_pools_server_active   — server connections actively in use
#   pgbouncer_pools_server_idle     — server connections idle in pool
#   pgbouncer_stats_total_requests_total — total queries routed

apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbouncer-grafana-dashboard
  labels:
    grafana_dashboard: "1"
  annotations:
    grafana_folder: "Infrastructure"
data:
  pgbouncer.json: |
    {
      "title": "PgBouncer",
      "uid": "pgbouncer-mathtrail",
      "schemaVersion": 38,
      "version": 1,
      "refresh": "30s",
      "time": { "from": "now-1h", "to": "now" },
      "templating": {
        "list": [
          {
            "name": "database",
            "type": "query",
            "datasource": { "type": "prometheus", "uid": "mimir" },
            "query": "label_values(pgbouncer_pools_client_active, database)",
            "includeAll": true,
            "multi": true,
            "current": { "value": "$__all" }
          }
        ]
      },
      "panels": [
        {
          "id": 1,
          "type": "timeseries",
          "title": "Client Connections — Active vs Waiting",
          "description": "client_waiting > 0 means the pool is saturated; scale up default_pool_size if sustained.",
          "gridPos": { "x": 0, "y": 0, "w": 12, "h": 8 },
          "datasource": { "type": "prometheus", "uid": "mimir" },
          "targets": [
            {
              "expr": "sum by (database) (pgbouncer_pools_client_active{database=~\"$database\"})",
              "legendFormat": "active — {{database}}"
            },
            {
              "expr": "sum by (database) (pgbouncer_pools_client_waiting{database=~\"$database\"})",
              "legendFormat": "waiting — {{database}}"
            }
          ],
          "fieldConfig": {
            "defaults": { "unit": "short", "min": 0 }
          }
        },
        {
          "id": 2,
          "type": "timeseries",
          "title": "Server Connections — Active vs Idle",
          "description": "server_active approaches default_pool_size (20) when the pool is fully utilised.",
          "gridPos": { "x": 12, "y": 0, "w": 12, "h": 8 },
          "datasource": { "type": "prometheus", "uid": "mimir" },
          "targets": [
            {
              "expr": "sum by (database) (pgbouncer_pools_server_active{database=~\"$database\"})",
              "legendFormat": "server active — {{database}}"
            },
            {
              "expr": "sum by (database) (pgbouncer_pools_server_idle{database=~\"$database\"})",
              "legendFormat": "server idle — {{database}}"
            }
          ],
          "fieldConfig": {
            "defaults": { "unit": "short", "min": 0 }
          }
        },
        {
          "id": 3,
          "type": "stat",
          "title": "Max Client Waiting (last 5 min)",
          "description": "If this stays above 0, the pool is a bottleneck — increase default_pool_size or scale PostgreSQL.",
          "gridPos": { "x": 0, "y": 8, "w": 6, "h": 4 },
          "datasource": { "type": "prometheus", "uid": "mimir" },
          "targets": [
            {
              "expr": "max(max_over_time(pgbouncer_pools_client_waiting[5m]))",
              "legendFormat": "max waiting"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  { "color": "green", "value": 0 },
                  { "color": "yellow", "value": 1 },
                  { "color": "red", "value": 10 }
                ]
              }
            }
          },
          "options": { "colorMode": "background" }
        },
        {
          "id": 4,
          "type": "timeseries",
          "title": "Request Rate (queries/s)",
          "gridPos": { "x": 6, "y": 8, "w": 18, "h": 4 },
          "datasource": { "type": "prometheus", "uid": "mimir" },
          "targets": [
            {
              "expr": "sum(rate(pgbouncer_stats_total_requests_total[1m]))",
              "legendFormat": "queries/s"
            }
          ],
          "fieldConfig": {
            "defaults": { "unit": "reqps", "min": 0 }
          }
        }
      ]
    }
