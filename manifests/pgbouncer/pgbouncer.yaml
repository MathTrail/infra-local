# PgBouncer — connection pooler for PostgreSQL
# Deployed in the mathtrail namespace alongside postgres.
#
# Auth strategy: auth_query against pg_shadow.
#   - pgbouncer_auth user (created by postgresql initdb script) holds SELECT on pg_shadow
#   - Only pgbouncer_auth's credentials are stored in the userlist Secret
#   - All other users are authenticated dynamically via auth_query (no userlist maintenance)
#
# Pool modes per database:
#   - transaction (default) for custom Go services — efficient multiplexing
#   - session for Ory services (Kratos/Hydra/Keto) — safe for prepared statements

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbouncer-config
  labels:
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/part-of: mathtrail
data:
  pgbouncer.ini: |
    [databases]
    kratos    = host=postgres-postgresql port=5432 dbname=kratos    pool_mode=session
    hydra     = host=postgres-postgresql port=5432 dbname=hydra     pool_mode=session
    keto      = host=postgres-postgresql port=5432 dbname=keto      pool_mode=session
    mentor    = host=postgres-postgresql port=5432 dbname=mentor    pool_mode=transaction
    profile   = host=postgres-postgresql port=5432 dbname=profile   pool_mode=transaction
    mathtrail = host=postgres-postgresql port=5432 dbname=mathtrail pool_mode=transaction

    [pgbouncer]
    listen_addr = 0.0.0.0
    listen_port = 6432

    ; Client auth: scram-sha-256 matches PostgreSQL 14+ default pg_hba.conf
    auth_type  = scram-sha-256
    auth_file  = /etc/pgbouncer/userlist.txt

    ; Dynamic auth: PgBouncer queries pg_shadow for each connecting user's verifier.
    ; Only pgbouncer_auth's credentials need to be in userlist.txt.
    auth_user  = pgbouncer_auth
    auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

    pool_mode        = transaction
    max_client_conn  = 1000
    default_pool_size = 20

    ; Reset session state between transactions (required for transaction pooling).
    server_reset_query        = DISCARD ALL
    server_reset_query_always = 1

    ; Suppress extra_float_digits mismatch from some drivers.
    ignore_startup_parameters = extra_float_digits

    ; Allow pgbouncer_auth to query pool statistics (used by the metrics exporter).
    stats_users = pgbouncer_auth

    log_connections    = 0
    log_disconnections = 0
    log_stats          = 1
    stats_period       = 60

---
# userlist.txt contains ONLY pgbouncer_auth credentials.
# All other users are looked up dynamically via auth_query against pg_shadow.
# NOTE: In production, store this Secret in Vault and sync via External Secrets Operator.
apiVersion: v1
kind: Secret
metadata:
  name: pgbouncer-userlist
  labels:
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/part-of: mathtrail
type: Opaque
stringData:
  userlist.txt: |
    "pgbouncer_auth" "pgbouncer_auth_pass"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer
  labels:
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/part-of: mathtrail
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: pgbouncer
  template:
    metadata:
      labels:
        app.kubernetes.io/name: pgbouncer
        app.kubernetes.io/part-of: mathtrail
      annotations:
        # Scraped by Alloy metrics DaemonSet (same annotations as other mathtrail services).
        prometheus.io/scrape: "true"
        prometheus.io/port: "9127"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: pgbouncer
          image: edoburu/pgbouncer:v1.23.1-p3
          ports:
            - name: pgbouncer
              containerPort: 6432
          volumeMounts:
            - name: config
              mountPath: /etc/pgbouncer/pgbouncer.ini
              subPath: pgbouncer.ini
              readOnly: true
            - name: userlist
              mountPath: /etc/pgbouncer/userlist.txt
              subPath: userlist.txt
              readOnly: true
          livenessProbe:
            tcpSocket:
              port: 6432
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            tcpSocket:
              port: 6432
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "128Mi"

        - name: pgbouncer-exporter
          image: prometheuscommunity/pgbouncer-exporter:v0.9.0
          args:
            - "--pgBouncer.connectionString=postgresql://pgbouncer_auth:pgbouncer_auth_pass@localhost:6432/pgbouncer?sslmode=disable"
          ports:
            - name: metrics
              containerPort: 9127
          resources:
            requests:
              cpu: "10m"
              memory: "16Mi"
            limits:
              cpu: "50m"
              memory: "32Mi"

      volumes:
        - name: config
          configMap:
            name: pgbouncer-config
        - name: userlist
          secret:
            secretName: pgbouncer-userlist

---
apiVersion: v1
kind: Service
metadata:
  # Named postgres-pgbouncer so services can use DB_HOST=postgres-pgbouncer
  name: postgres-pgbouncer
  labels:
    app.kubernetes.io/name: pgbouncer
    app.kubernetes.io/part-of: mathtrail
spec:
  selector:
    app.kubernetes.io/name: pgbouncer
  ports:
    - name: pgbouncer
      port: 6432
      targetPort: 6432
