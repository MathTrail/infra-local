# ServiceAccount for the vault-db-init Job.
# Needs no special permissions itself — Vault does the TokenReview via its own SA.
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-db-init

---
# Job: configure per-namespace Vault database secrets for local development.
# Creates the DB connection config and dynamic role in Vault for this namespace.
# Requires vault-cluster-init (from infra/) to have run first.
# Runs once; RestartPolicy=OnFailure handles transient startup races.
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-db-init
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: vault-db-init
      containers:
        - name: vault-db-init
          image: hashicorp/vault:1.17
          env:
            - name: VAULT_ADDR
              value: "http://vault.vault.svc.cluster.local:8200"
            - name: VAULT_TOKEN
              value: "root"
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: PG_HOST
              value: "postgres-postgresql.$(NAMESPACE).svc.cluster.local"
            - name: PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-postgresql
                  key: postgres-password
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e

              echo "Waiting for Vault to be ready..."
              until vault status 2>/dev/null; do
                echo "  vault not ready, retrying in 3s..."
                sleep 3
              done
              echo "Vault is ready."

              # ── Database connection config ───────────────────────────────
              vault write database/config/mentor-postgres-${NAMESPACE} \
                plugin_name="postgresql-database-plugin" \
                allowed_roles="mentor-api-role-${NAMESPACE}" \
                connection_url="postgresql://postgres:${PG_PASSWORD}@${PG_HOST}:5432/mentor?sslmode=disable" \
                username="postgres" \
                password="${PG_PASSWORD}"

              # Dynamic role: short-lived users with DML access on the mentor DB.
              # TTL 1h (default), max 24h. ESO refreshes at 55m to stay ahead of expiry.
              vault write database/roles/mentor-api-role-${NAMESPACE} \
                db_name="mentor-postgres-${NAMESPACE}" \
                creation_statements="
                  CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
                  GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO \"{{name}}\";
                  GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO \"{{name}}\";
                " \
                revocation_statements="DROP ROLE IF EXISTS \"{{name}}\";" \
                default_ttl="1h" \
                max_ttl="24h"

              echo "Vault DB init complete."
